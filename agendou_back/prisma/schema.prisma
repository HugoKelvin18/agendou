// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                       Int               @id @default(autoincrement())
  businessId               Int
  nome                     String
  email                    String
  senha                    String
  telefone                 String?
  role                     Role              @default(CLIENTE)
  mensagemPublica          String?
  cidade                   String?
  bairro                   String?
  endereco                 String?
  numero                   String?
  complemento              String?
  uf                       String?
  cep                      String?
  whatsapp                 String?
  emailPublico             String?
  instagram                String?
  facebook                 String?
  tiktok                   String?
  site                     String?
  linkedin                 String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  business                 Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  servicos                 Servico[]         @relation("ProfissionalServicos")
  agendamentosCliente      Agendamento[]     @relation("ClienteAgendamentos")
  agendamentosProfissional Agendamento[]     @relation("ProfissionalAgendamentos")
  disponibilidades         Disponibilidade[] @relation("ProfissionalDisponibilidades")
  notificacoesLidas        NotificacaoLida[]

  @@unique([businessId, email])
  @@index([businessId])
  @@map("usuarios")
}

model Servico {
  id             Int      @id @default(autoincrement())
  businessId     Int
  nome           String
  descricao      String
  preco          Float
  duracao        Int // em minutos
  imagemUrl      String?
  profissionalId Int
  ativo          Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  profissional Usuario       @relation("ProfissionalServicos", fields: [profissionalId], references: [id], onDelete: Cascade)
  agendamentos Agendamento[]

  @@index([businessId])
  @@map("servicos")
}

model Disponibilidade {
  id             Int      @id @default(autoincrement())
  businessId     Int
  profissionalId Int
  data           DateTime
  horaInicio     Int // em minutos desde meia-noite
  horaFim        Int // em minutos desde meia-noite
  intervaloMin   Int      @default(30) // intervalo mínimo entre agendamentos
  disponivel     Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  profissional Usuario  @relation("ProfissionalDisponibilidades", fields: [profissionalId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("disponibilidades")
}

model Agendamento {
  id             Int               @id @default(autoincrement())
  businessId     Int
  clienteId      Int
  profissionalId Int
  servicoId      Int
  data           DateTime
  hora           String // formato "HH:mm"
  status         StatusAgendamento @default(PENDENTE)
  criadoEm       DateTime          @default(now())
  atualizadoEm   DateTime          @updatedAt

  // Relações
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  cliente      Usuario  @relation("ClienteAgendamentos", fields: [clienteId], references: [id], onDelete: Cascade)
  profissional Usuario  @relation("ProfissionalAgendamentos", fields: [profissionalId], references: [id], onDelete: Cascade)
  servico      Servico  @relation(fields: [servicoId], references: [id], onDelete: Restrict)

  @@index([businessId])
  @@map("agendamentos")
}

model NotificacaoLida {
  id            Int      @id @default(autoincrement())
  usuarioId     Int
  notificacaoId String // ID da notificação (pode ser "app-1", "msg-2", etc.)
  createdAt     DateTime @default(now())

  // Relações
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, notificacaoId])
  @@map("notificacoes_lidas")
}

model CodigoAcesso {
  id         Int       @id @default(autoincrement())
  businessId Int
  codigo     String
  ativo      Boolean   @default(true)
  expiraEm   DateTime? // Opcional: data de expiração
  descricao  String? // Opcional: descrição do código
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, codigo])
  @@index([businessId])
  @@map("codigos_acesso")
}

model Business {
  id        Int      @id @default(autoincrement())
  nome      String
  slug      String   @unique
  dominio   String?  @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  usuarios         Usuario[]
  servicos         Servico[]
  disponibilidades Disponibilidade[]
  agendamentos     Agendamento[]
  codigosAcesso    CodigoAcesso[]

  @@index([slug])
  @@index([dominio])
  @@map("businesses")
}

enum Role {
  CLIENTE
  PROFISSIONAL
}

enum StatusAgendamento {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}
